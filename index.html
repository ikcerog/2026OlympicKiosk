<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milano Cortina 2026 Kiosk Dashboard (Final)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=TASA+Explorer:wght@400..800&display=swap');
    </style>

    <style>
        :root {
            --font-primary: 'Inter', sans-serif;
            --font-heading: 'TASA Explorer', sans-serif;
            --color-gold: #FFD700;
            --color-silver: #C0C0C0;
            --color-bronze: #CD7F32;
            --color-background: #002244;
            --color-text-light: #F0F8FF;
            --color-accent: #E30613;
            --control-height: 80px;
            
            /* Base Font Sizes (using viewport units for dynamic scaling) */
            --font-size-h1: 3.5vw;
            --font-size-h2: 2.0vw;
            --font-size-base: 1.5vw;
            --font-size-lg: 1.8vw;

            /* Max size constraints for ultra-wide screens */
            --max-font-size-button: 20px;
            --max-width-button: 200px;
            --max-font-size-dropdown: 18px;
        }
        
        body {
            font-family: var(--font-primary);
            color: var(--color-text-light);
            margin: 0;
            padding: 0;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* --- DYNAMIC BACKGROUND LAYERS --- */
        .background-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 1s ease-in-out; 
            filter: blur(5px) brightness(0.7);
            z-index: -1;
        }
        
        #bg-1 { background-image: url('./img/001.jpg'); opacity: 1; }
        #bg-2 { background-image: url('./img/002.jpg'); }

        /* Foreground Gradient Overlay */
        #gradient-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 34, 68, 0.7);
            z-index: -1;
        }

        /* --- HISTORICAL DATA DROPDOWN & REFRESH BUTTON --- */
        #historical-data {
            position: absolute;
            top: 20px;
            right: 50px;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #historical-data select {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--color-text-light);
            border: 1px solid var(--color-gold);
            padding: 8px 15px;
            border-radius: 5px;
            font-family: var(--font-heading);
            font-size: clamp(14px, 1.2vw, var(--max-font-size-dropdown));
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23F0F8FF' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.757 7.586 5.343 9z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1.5em;
        }
        #historical-data select:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        #refresh-data {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--color-text-light);
            border: 1px solid var(--color-gold);
            padding: 8px 15px;
            border-radius: 5px;
            font-family: var(--font-heading);
            font-size: clamp(14px, 1.2vw, 18px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #refresh-data:hover {
            background-color: rgba(255, 215, 0, 0.3);
            transform: rotate(180deg);
        }
        #refresh-data:active {
            transform: rotate(360deg);
        }
        #data-source-indicator {
            font-size: clamp(10px, 0.9vw, 14px);
            color: var(--color-gold);
            margin-bottom: 5px;
            opacity: 0.8;
            font-family: var(--font-primary);
        }

        /* --- LIVE DATA DISCLAIMER --- */
        #live-data-notice {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 34, 68, 0.9);
            border: 1px solid var(--color-gold);
            padding: 8px 16px;
            border-radius: 5px;
            font-size: clamp(9px, 0.8vw, 12px);
            color: var(--color-text-light);
            opacity: 0.7;
            z-index: 100;
            font-family: var(--font-primary);
            max-width: 90%;
            text-align: center;
        }

        /* --- CUSTOM TOOLTIP CSS --- */
        #chartjs-tooltip {
            opacity: 0;
            pointer-events: none; 
            position: absolute;
            background: rgba(0, 34, 68, 0.95); 
            color: #F0F8FF;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid var(--color-gold);
            transition: opacity 0.1s ease;
            z-index: 100; 
            font-family: var(--font-primary);
            font-size: 1.1vw;
            min-width: 150px;
        }

        /* --- DASHBOARD ELEMENTS --- */
        #dashboard-container {
            width: 100%;
            height: calc(100% - var(--control-height)); 
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.1);
        }

        .panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 30px 50px;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .panel.active {
            opacity: 1;
            z-index: 10;
        }
        
        h1 { 
            font-family: var(--font-heading); 
            font-size: var(--font-size-h1);
            margin-bottom: 5px; 
            font-weight: 800;
        }
        h2 { 
            font-family: var(--font-heading); 
            font-size: var(--font-size-h2);
            border-bottom: 3px solid var(--color-accent); 
            padding-bottom: 5px; 
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Emojis/Flags in Panel Text */
        .event-list .sport::before, .flag-emoji, #spotlight .logo {
            font-size: var(--font-size-lg); 
            margin-right: 10px;
        }

        /* Panel 1: Schedule */
        .event-list {
            list-style: none;
            padding: 0;
            width: 95%;
            max-height: 80%;
            overflow-y: auto;
            text-align: left;
            font-family: var(--font-primary);
        }
        .event-list li {
            background: rgba(255, 255, 255, 0.15);
            margin-bottom: 8px;
            padding: 12px 18px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-base);
        }
        .event-list .time { 
            color: var(--color-gold); 
            font-weight: 700; 
            font-family: var(--font-heading); 
            font-size: var(--font-size-lg);
        }

        /* Panel 2: Medal Tally - Chart Container */
        #medal-tally-chart-container {
            width: 95%;
            height: 70vh;
            margin-top: 10px;
            position: relative; /* CRITICAL: Sets the positioning context for the absolute tooltip */
        }
        
        #view-toggles {
            margin-bottom: 10px;
        }
        .view-toggle-button {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--color-text-light);
            border: 1px solid var(--color-gold);
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 5px;
            font-family: var(--font-heading);
            font-size: clamp(12px, 1.1vw, 18px);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .view-toggle-button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .view-toggle-button.active {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
        }

        /* Panel 3: Spotlight */
        #spotlight .countdown {
            font-size: 8vw;
            font-weight: 800;
            font-family: var(--font-heading); 
            color: var(--color-gold);
            margin-top: 20px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #spotlight p { font-size: var(--font-size-lg); margin-top: 10px; }

        /* KIOSK CONTROLS */
        #kiosk-controls {
            width: 100%;
            height: var(--control-height);
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            box-sizing: border-box;
            z-index: 20;
        }
        .control-button {
            background-color: var(--color-accent);
            color: var(--color-text-light);
            border: none;
            padding: 15px 30px;
            margin: 0 10px;
            
            /* Apply max size constraints */
            font-size: clamp(14px, 1.2vw, var(--max-font-size-button));
            max-width: var(--max-width-button);
            
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-weight: 600;
            font-family: var(--font-heading);
        }
        .control-button:hover {
            background-color: #A9040F;
        }
        .control-button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }
        #speed-toggle {
            background-color: #555;
        }
        #speed-toggle:hover {
            background-color: #777;
        }
        
        /* --- MOBILE/VERTICAL SCREEN STYLING (Responsive Flow) --- */
        @media (max-width: 768px), (orientation: portrait) {
            :root {
                --font-size-h1: 7vw;
                --font-size-h2: 4.5vw;
                --font-size-base: 3.5vw;
                --font-size-lg: 4.5vw;
                --control-height: 10vh;
            }

            .panel {
                padding: 20px;
            }
            
            #historical-data {
                top: 10px;
                right: 10px;
            }
            
            #spotlight .countdown {
                font-size: 15vw;
            }
            
            #kiosk-controls {
                flex-wrap: wrap;
                justify-content space-around;
                padding: 5px;
            }

            .control-button {
                padding: 10px 15px;
                margin: 5px;
                font-size: 3vw;
                flex-grow: 1;
                min-width: 40%;
                max-width: 100%;
            }
            
            #medal-tally-chart-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    
    <div id="bg-1" class="background-layer"></div>
    <div id="bg-2" class="background-layer"></div>
    <div id="gradient-overlay"></div>
    
    <div id="chartjs-tooltip"></div>
    
    <div id="historical-data">
        <select id="event-selector">
            <option value="2026-current">Milano Cortina 2026 (Current)</option>
            <option value="2022-winter">Beijing 2022 (Winter)</option>
            <option value="2020-summer">Tokyo 2020 (Summer)</option>
            <option value="2018-winter">PyeongChang 2018 (Winter)</option>
        </select>
        <button id="refresh-data" title="Refresh data from APIs">üîÑ</button>
    </div>

    <div id="dashboard-container">

        <div id="schedule" class="panel active">
            <h1>TODAY'S SCHEDULE</h1>
            <h2>Upcoming Medal Events</h2>
            <ul class="event-list"></ul>
        </div>

        <div id="medal-tally" class="panel">
            <h1>üèÖ MEDAL STANDINGS</h1>
            <h2 id="medal-tally-subtitle">Top 10 Nations (Stacked Bar Chart)</h2>

            <div id="view-toggles">
                <button id="view-stacked" class="view-toggle-button active" data-type="stacked">Stacked View</button>
                <button id="view-separate" class="view-toggle-button" data-type="separate">Separate View</button>
            </div>

            <div id="data-source-indicator">Loading data...</div>

            <div id="medal-tally-chart-container">
                <canvas id="medalChart"></canvas>
            </div>
        </div>

        <div id="spotlight" class="panel">
            <div class="logo">üáÆüáπüèîÔ∏è</div>
            <h1>MILANO CORTINA 2026</h1>
            <h2>Countdown to the Games</h2>
            <div id="countdown-timer" class="countdown">-- days --</div>
            <p>February 6 ‚Äì 22, 2026</p>
        </div>

    </div>

    <div id="kiosk-controls">
        <button id="prev-button" class="control-button">‚¨ÖÔ∏è BACK</button>
        <button id="pause-button" class="control-button">‚è∏Ô∏è PAUSE</button>
        <button id="next-button" class="control-button">FORWARD ‚û°Ô∏è</button>
        <button id="speed-toggle" class="control-button">üê¢ SLOW SWAP (15s)</button>
    </div>

    <div id="live-data-notice">
        ‚ÑπÔ∏è Near-Live Display: Medal counts update every 5 minutes from Wikipedia. Data may lag official results by 5-15 minutes.
    </div>

    <script>
        // --- 1. DATA SOURCES & CACHING ---

        const DATA_SOURCES = {
            WIKIPEDIA: 'wikipedia',
            CODANTE: 'codante',
            MOCK: 'mock'
        };

        let currentDataSource = DATA_SOURCES.MOCK;
        let lastDataUpdate = null;
        let dataCache = {
            '2026-current': null,
            '2022-winter': null,
            '2020-summer': null,
            '2018-winter': null
        };
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // MOCK DATA (Fallback)
        const MOCK_DATA_2026 = [
            { rank: 1, country: "Norway", code: "NOR", G: 16, S: 8, B: 13, T: 37 },
            { rank: 2, country: "Germany", code: "GER", G: 12, S: 10, B: 5, T: 27 },
            { rank: 3, country: "Canada", code: "CAN", G: 4, S: 8, B: 14, T: 26 },
            { rank: 4, country: "USA", code: "USA", G: 8, S: 10, B: 7, T: 25 },
            { rank: 5, country: "Sweden", code: "SWE", G: 8, S: 5, B: 5, T: 18 },
            { rank: 6, country: "Austria", code: "AUT", G: 7, S: 7, B: 4, T: 18 },
            { rank: 7, country: "Italy", code: "ITA", G: 2, S: 7, B: 8, T: 17 },
            { rank: 8, country: "Japan", code: "JPN", G: 3, S: 6, B: 9, T: 18 },
            { rank: 9, country: "Netherlands", code: "NED", G: 8, S: 5, B: 4, T: 17 },
            { rank: 10, country: "China", code: "CHN", G: 9, S: 4, B: 2, T: 15 },
        ].sort((a, b) => b.T - a.T); 
        
        const MOCK_DATA_2022 = [
            { rank: 1, country: "Norway", code: "NOR", G: 16, S: 8, B: 13, T: 37 },
            { rank: 2, country: "Germany", code: "GER", G: 12, S: 10, B: 5, T: 27 },
            { rank: 3, country: "China", code: "CHN", G: 9, S: 4, B: 2, T: 15 },
            { rank: 4, country: "USA", code: "USA", G: 8, S: 10, B: 7, T: 25 },
            { rank: 5, country: "Sweden", code: "SWE", G: 8, S: 5, B: 5, T: 18 },
            { rank: 6, country: "Netherlands", code: "NED", G: 8, S: 5, B: 4, T: 17 },
            { rank: 7, country: "Austria", code: "AUT", G: 7, S: 7, B: 4, T: 18 },
            { rank: 8, country: "Switzerland", code: "SUI", G: 7, S: 2, B: 5, T: 14 },
            { rank: 9, country: "ROC", code: "RUS", G: 6, S: 12, B: 14, T: 32 },
            { rank: 10, country: "France", code: "FRA", G: 5, S: 7, B: 2, T: 14 },
        ].sort((a, b) => b.T - a.T);

        const MOCK_DATA_2020 = [
            { rank: 1, country: "USA", code: "USA", G: 39, S: 41, B: 33, T: 113 },
            { rank: 2, country: "China", code: "CHN", G: 38, S: 32, B: 19, T: 89 },
            { rank: 3, country: "Japan", code: "JPN", G: 27, S: 14, B: 17, T: 58 },
            { rank: 4, country: "Great Britain", code: "GBR", G: 22, S: 21, B: 22, T: 65 },
            { rank: 5, country: "Australia", code: "AUS", G: 17, S: 7, B: 22, T: 46 },
            { rank: 6, country: "Netherlands", code: "NED", G: 10, S: 12, B: 14, T: 36 },
            { rank: 7, country: "France", code: "FRA", G: 10, S: 12, B: 11, T: 33 },
            { rank: 8, country: "Germany", code: "GER", G: 10, S: 11, B: 16, T: 37 },
            { rank: 9, country: "Italy", code: "ITA", G: 10, S: 10, B: 20, T: 40 },
            { rank: 10, country: "Canada", code: "CAN", G: 7, S: 7, B: 10, T: 24 },
        ].sort((a, b) => b.T - a.T);
        
        const scheduleData = [
            { sport: "Alpine Skiing", event: "Men's Downhill - GOLD MEDAL", time: "5:30 AM ET", date: "Feb 7" },
            { sport: "Snowboard", event: "Women's Slopestyle Final - GOLD MEDAL", time: "6:00 AM ET", date: "Feb 7" },
            { sport: "Cross-Country", event: "Women's 10km+10km Skiathlon - GOLD MEDAL", time: "7:00 AM ET", date: "Feb 7" },
            { sport: "Ski Jumping", event: "Men's Normal Hill Individual - GOLD MEDAL", time: "8:30 AM ET", date: "Feb 7" },
            { sport: "Speed Skating", event: "Women's 3000m Final - GOLD MEDAL", time: "9:00 AM ET", date: "Feb 7" },
            { sport: "Freestyle Skiing", event: "Women's Moguls Final - GOLD MEDAL", time: "11:00 AM ET", date: "Feb 7" },
            { sport: "Figure Skating", event: "Team Event - Short Programs", time: "2:00 PM ET", date: "Feb 7" }
        ];

        // --- API FETCHING FUNCTIONS ---

        async function fetchWikipediaMedalData(eventKey) {
            try {
                const pageMap = {
                    '2026-current': '2026_Winter_Olympics',
                    '2022-winter': '2022_Winter_Olympics',
                    '2020-summer': '2020_Summer_Olympics',
                    '2018-winter': '2018_Winter_Olympics'
                };

                const page = pageMap[eventKey];
                if (!page) return null;

                const url = `https://en.wikipedia.org/api/rest_v1/page/html/${page}`;
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'Milano-Cortina-2026-Kiosk/1.0',
                        'Api-User-Agent': 'Milano-Cortina-2026-Kiosk/1.0'
                    }
                });

                if (!response.ok) throw new Error(`Wikipedia API error: ${response.status}`);

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Find medal table (usually has class "wikitable" and contains "Medal")
                const tables = doc.querySelectorAll('table.wikitable');
                let medalTable = null;

                for (let table of tables) {
                    const text = table.textContent.toLowerCase();
                    if ((text.includes('medal') || text.includes('rank')) &&
                        (text.includes('gold') || text.includes('silver'))) {
                        medalTable = table;
                        break;
                    }
                }

                if (!medalTable) {
                    console.log('No medal table found in Wikipedia page');
                    return null;
                }

                // Parse table rows
                const rows = medalTable.querySelectorAll('tr');
                const medalData = [];

                for (let i = 1; i < rows.length && medalData.length < 10; i++) {
                    const cells = rows[i].querySelectorAll('th, td');
                    if (cells.length < 5) continue;

                    // Extract rank, country, code, and medals
                    const rankText = cells[0]?.textContent.trim();
                    const countryText = cells[1]?.textContent.trim();
                    const gold = parseInt(cells[2]?.textContent.trim()) || 0;
                    const silver = parseInt(cells[3]?.textContent.trim()) || 0;
                    const bronze = parseInt(cells[4]?.textContent.trim()) || 0;
                    const total = parseInt(cells[5]?.textContent.trim()) || (gold + silver + bronze);

                    if (!countryText || isNaN(gold)) continue;

                    // Extract country code (usually in parentheses or as abbreviation)
                    const codeMatch = countryText.match(/\(([A-Z]{3})\)/);
                    let code = codeMatch ? codeMatch[1] : '';

                    // Clean country name
                    let country = countryText.replace(/\([^)]*\)/g, '').trim();
                    country = country.replace(/\[.*?\]/g, '').trim();

                    // Try to infer code from country name if not found
                    if (!code) {
                        code = inferCountryCode(country);
                    }

                    medalData.push({
                        rank: parseInt(rankText) || (i),
                        country: country,
                        code: code,
                        G: gold,
                        S: silver,
                        B: bronze,
                        T: total
                    });
                }

                if (medalData.length > 0) {
                    console.log(`Fetched ${medalData.length} countries from Wikipedia for ${eventKey}`);
                    currentDataSource = DATA_SOURCES.WIKIPEDIA;
                    return medalData;
                }

                return null;
            } catch (error) {
                console.error('Wikipedia fetch error:', error);
                return null;
            }
        }

        async function fetchCodanteData(eventKey) {
            try {
                // Codante.io currently only has 2024 data, but we'll try anyway
                const response = await fetch('https://apis.codante.io/olympic-games/countries', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`Codante API error: ${response.status}`);

                const data = await response.json();

                if (!data || !data.data) return null;

                // Convert Codante format to our format
                const medalData = data.data
                    .sort((a, b) => (b.gold_medals + b.silver_medals + b.bronze_medals) -
                                     (a.gold_medals + a.silver_medals + a.bronze_medals))
                    .slice(0, 10)
                    .map((country, index) => ({
                        rank: index + 1,
                        country: country.name,
                        code: country.id,
                        G: country.gold_medals || 0,
                        S: country.silver_medals || 0,
                        B: country.bronze_medals || 0,
                        T: (country.gold_medals || 0) + (country.silver_medals || 0) + (country.bronze_medals || 0)
                    }));

                if (medalData.length > 0) {
                    console.log(`Fetched ${medalData.length} countries from Codante.io`);
                    currentDataSource = DATA_SOURCES.CODANTE;
                    return medalData;
                }

                return null;
            } catch (error) {
                console.error('Codante fetch error:', error);
                return null;
            }
        }

        function inferCountryCode(countryName) {
            const countryMap = {
                'norway': 'NOR', 'germany': 'GER', 'canada': 'CAN', 'united states': 'USA',
                'sweden': 'SWE', 'austria': 'AUT', 'italy': 'ITA', 'japan': 'JPN',
                'netherlands': 'NED', 'china': 'CHN', 'switzerland': 'SUI', 'russia': 'RUS',
                'russian olympic committee': 'ROC', 'roc': 'ROC', 'france': 'FRA',
                'great britain': 'GBR', 'australia': 'AUS', 'south korea': 'KOR',
                'republic of korea': 'KOR', 'finland': 'FIN', 'spain': 'ESP',
                'czech republic': 'CZE', 'poland': 'POL', 'new zealand': 'NZL'
            };
            return countryMap[countryName.toLowerCase()] || countryName.substring(0, 3).toUpperCase();
        }

        async function fetchMedalData(eventKey, forceRefresh = false) {
            // Check cache first
            if (!forceRefresh && dataCache[eventKey]) {
                const cacheAge = Date.now() - dataCache[eventKey].timestamp;
                if (cacheAge < CACHE_DURATION) {
                    console.log(`Using cached data for ${eventKey} (age: ${Math.round(cacheAge/1000)}s)`);
                    currentDataSource = dataCache[eventKey].source;
                    lastDataUpdate = dataCache[eventKey].timestamp;
                    return dataCache[eventKey].data;
                }
            }

            // Try Wikipedia first
            console.log(`Fetching fresh data for ${eventKey} from Wikipedia...`);
            let data = await fetchWikipediaMedalData(eventKey);

            // Fallback to Codante for 2024 data
            if (!data && eventKey === '2020-summer') {
                console.log('Wikipedia failed, trying Codante.io...');
                data = await fetchCodanteData(eventKey);
            }

            // Fallback to mock data
            if (!data) {
                console.log('All APIs failed, using mock data');
                currentDataSource = DATA_SOURCES.MOCK;
                data = getMockData(eventKey);
            }

            // Cache the result
            if (data) {
                dataCache[eventKey] = {
                    data: data,
                    timestamp: Date.now(),
                    source: currentDataSource
                };
                lastDataUpdate = Date.now();
            }

            return data;
        }

        function getMockData(eventKey) {
            switch (eventKey) {
                case '2022-winter': return MOCK_DATA_2022;
                case '2020-summer': return MOCK_DATA_2020;
                case '2018-winter': return MOCK_DATA_2022; // Using 2022 as placeholder
                case '2026-current':
                default: return MOCK_DATA_2026;
            }
        }

        function getFlagEmoji(code) {
            const flags = {
                'NOR': 'üá≥üá¥', 'GER': 'üá©üá™', 'CAN': 'üá®üá¶', 'USA': 'üá∫üá∏', 'SWE': 'üá∏üá™',
                'AUT': 'üá¶üáπ', 'ITA': 'üáÆüáπ', 'JPN': 'üáØüáµ', 'NED': 'üá≥üá±', 'CHN': 'üá®üá≥',
                'SUI': 'üá®üá≠', 'RUS': 'üá∑üá∫', 'FRA': 'üá´üá∑', 'GBR': 'üá¨üáß', 'AUS': 'üá¶üá∫',
                'KOR': 'üá∞üá∑', 'ROC': 'üá∑üá∫', 'FIN': 'üá´üáÆ', 'ESP': 'üá™üá∏', 'CZE': 'üá®üáø',
                'POL': 'üáµüá±', 'NZL': 'üá≥üáø'
            };
            return flags[code] || 'üö©';
        }
        
        let medalChart; 
        let currentChartType = 'stacked';
        let currentChartDataKey = '2026-current';
        
        // --- CUSTOM TOOLTIP FUNCTION ---
        function customTooltip(context) {
            let tooltipEl = document.getElementById('chartjs-tooltip');
            const chart = context.chart;
            const container = document.getElementById('medal-tally-chart-container');

            if (!container.contains(tooltipEl)) {
                container.appendChild(tooltipEl);
            }

            const tooltipModel = context.tooltip;

            if (tooltipModel.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
            }

            // --- FIX: Use dataPoints to get specific medal data ---
            if (tooltipModel.dataPoints && tooltipModel.dataPoints.length > 0) {
                // The title is the country name (same for all segments of the bar)
                const title = tooltipModel.title[0] || '';
                
                let innerHtml = '<div>';
                
                // Title (Country Name)
                const codeMatch = title.match(/\(([A-Z]+)\)/);
                const code = codeMatch ? codeMatch[1] : '';
                const flag = getFlagEmoji(code);
                
                innerHtml += '<div style="font-weight: 700; font-size: 1.2em; border-bottom: 1px solid var(--color-gold); padding-bottom: 5px; margin-bottom: 5px;">' + flag + ' ' + title + '</div>';

                // Content (Medal and Count) - We only want the specific medal being hovered.
                // In stacked bar mode, Chart.js returns ALL datasets at that index, 
                // but for custom tooltips, we usually just want the single hovered item for a better UX.
                // In the default 'index' mode, it will return all of them if not specified otherwise.
                
                // Since we are setting mode: 'index' AND intersect: false, 
                // dataPoints will contain ALL three medals for the *row*, which is often desirable for a summary.
                
                // Let's iterate through all data points for that country row:
                tooltipModel.dataPoints.forEach(function(dataPoint) {
                    const label = dataPoint.dataset.label;
                    const value = dataPoint.formattedValue;
                    const color = dataPoint.dataset.backgroundColor;
                    
                    innerHtml += '<div style="margin: 3px 0; display: flex; justify-content: space-between;">';
                    innerHtml += '<span style="display: inline-block; width: 10px; height: 10px; margin-right: 5px; background-color:' + color + ';"></span>';
                    innerHtml += '<span>' + label + '</span>';
                    innerHtml += '<span>' + value + '</span>';
                    innerHtml += '</div>';
                });

                // Add Total at the bottom
                const total = tooltipModel.dataPoints.reduce((sum, dp) => sum + dp.parsed.x, 0);
                innerHtml += '<div style="font-weight: 700; margin-top: 5px; padding-top: 5px; border-top: 1px solid var(--color-gold); display: flex; justify-content: space-between;">';
                innerHtml += '<span>TOTAL:</span>';
                innerHtml += '<span>' + total + '</span>';
                innerHtml += '</div>';

                innerHtml += '</div>';
                tooltipEl.innerHTML = innerHtml;
            }

            // Calculate position relative to the chart container (which is position: relative)
            let x = tooltipModel.caretX + 15;
            let y = tooltipModel.caretY - tooltipEl.clientHeight / 2;

            // Boundary check: move left if too close to the right edge of the chart area
            if (x + tooltipEl.clientWidth > chart.width) {
                x = tooltipModel.caretX - tooltipEl.clientWidth - 15;
            }
            
            // Set position and show
            tooltipEl.style.left = x + 'px';
            tooltipEl.style.top = y + 'px';
            tooltipEl.style.opacity = 1;
        }


        // --- 2. DATA RENDERING FUNCTIONS ---

        async function loadHistoricalData(eventKey, chartType = currentChartType, forceRefresh = false) {
            currentChartDataKey = eventKey;
            let title;

            // Show loading indicator
            updateDataSourceIndicator('loading');

            switch (eventKey) {
                case '2022-winter':
                    title = "Beijing 2022 Medal Count (Winter)";
                    break;
                case '2020-summer':
                    title = "Tokyo 2020 Medal Count (Summer)";
                    break;
                case '2018-winter':
                    title = "PyeongChang 2018 Medal Count (Winter)";
                    break;
                case '2026-current':
                default:
                    title = "Top 10 Nations";
                    break;
            }

            try {
                const data = await fetchMedalData(eventKey, forceRefresh);
                document.getElementById('medal-tally-subtitle').textContent = `${title} (${chartType === 'stacked' ? 'Stacked Bar' : 'Grouped Bars'})`;
                renderMedalTally(data, chartType);
                updateDataSourceIndicator('success');
            } catch (error) {
                console.error('Error loading data:', error);
                const fallbackData = getMockData(eventKey);
                renderMedalTally(fallbackData, chartType);
                updateDataSourceIndicator('error');
            }
        }

        function updateDataSourceIndicator(status) {
            const indicator = document.getElementById('data-source-indicator');
            if (!indicator) return;

            let sourceText = '';
            let statusIcon = '';

            if (status === 'loading') {
                sourceText = 'Loading...';
                statusIcon = '‚è≥';
            } else if (status === 'error') {
                sourceText = 'Using fallback data';
                statusIcon = '‚ö†Ô∏è';
            } else {
                switch (currentDataSource) {
                    case DATA_SOURCES.WIKIPEDIA:
                        sourceText = 'Wikipedia';
                        statusIcon = '‚úì';
                        break;
                    case DATA_SOURCES.CODANTE:
                        sourceText = 'Codante.io API';
                        statusIcon = '‚úì';
                        break;
                    case DATA_SOURCES.MOCK:
                        sourceText = 'Mock Data';
                        statusIcon = '‚ÑπÔ∏è';
                        break;
                }

                if (lastDataUpdate) {
                    const minutesAgo = Math.round((Date.now() - lastDataUpdate) / 60000);
                    sourceText += ` (${minutesAgo}m ago)`;
                }
            }

            indicator.innerHTML = `${statusIcon} ${sourceText}`;
        }

        function renderMedalTally(currentData = MOCK_DATA_2026, chartType = currentChartType) {
            currentChartType = chartType;
            const ctx = document.getElementById('medalChart').getContext('2d');
            
            const getComputedFontSize = (baseVW) => {
                const vw = window.innerWidth / 100;
                return Math.min(baseVW * vw, 24) + 'px'; 
            };
            
            const chartFontSizeBase = getComputedFontSize(1.2); 
            const chartFontSizeHeading = getComputedFontSize(1.6); 

            // Labels include the total medal count in parentheses
            const labels = currentData.map(c => `${getFlagEmoji(c.code)} ${c.country} (${c.T})`);
            const goldData = currentData.map(c => c.G);
            const silverData = currentData.map(c => c.S);
            const bronzeData = currentData.map(c => c.B);
            
            const textColor = document.documentElement.style.getPropertyValue('--color-text-light') || '#F0F8FF';

            // Ensure complete destruction before creation
            if (medalChart instanceof Chart) {
                medalChart.destroy();
            }

            const isStacked = chartType === 'stacked';

            medalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Bronze',
                            data: bronzeData,
                            backgroundColor: document.documentElement.style.getPropertyValue('--color-bronze') || '#CD7F32',
                            borderColor: 'var(--color-background)',
                            borderWidth: 1
                        },
                        {
                            label: 'Silver',
                            data: silverData,
                            backgroundColor: document.documentElement.style.getPropertyValue('--color-silver') || '#C0C0C0',
                            borderColor: 'var(--color-background)',
                            borderWidth: 1
                        },
                        {
                            label: 'Gold',
                            data: goldData,
                            backgroundColor: document.documentElement.style.getPropertyValue('--color-gold') || '#FFD700',
                            borderColor: 'var(--color-background)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: isStacked, // Dynamic stacking
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: textColor, font: { size: chartFontSizeBase, family: 'var(--font-primary)' } },
                            title: { display: true, text: 'Medals Count', color: textColor, font: { size: chartFontSizeHeading, family: 'var(--font-heading)' } }
                        },
                        y: {
                            stacked: isStacked, // Dynamic stacking
                            grid: { display: false },
                            ticks: { color: textColor, font: { size: chartFontSizeBase, family: 'var(--font-primary)' } }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { size: chartFontSizeHeading, family: 'var(--font-heading)' },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            // The key is to use a mode that targets the country row, 
                            // even if a specific bar segment is hovered. 'index' is correct for horizontal bars.
                            enabled: false,
                            external: customTooltip,
                            mode: 'index',
                            intersect: false 
                        }
                    },
                    // Hide custom tooltip when not hovering over the chart area
                    onHover: (e, activeElements, chart) => {
                        if (activeElements.length === 0) {
                            document.getElementById('chartjs-tooltip').style.opacity = 0;
                        }
                    }
                }
            });
        }
        
        function renderSchedule() {
            const list = document.querySelector('#schedule .event-list');
            list.innerHTML = '';
            scheduleData.forEach(event => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="sport">${event.sport}: ${event.event}</span>
                    <span class="time">${event.date} ‚Ä¢ ${event.time}</span>
                `;
                list.appendChild(listItem);
            });
        }

        function updateCountdown() {
            const targetDate = new Date("Feb 6, 2026 00:00:00 EST").getTime();
            const now = new Date().getTime();
            const distance = targetDate - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            
            const countdownEl = document.getElementById("countdown-timer");

            if (distance < 0) {
                countdownEl.innerHTML = "GAMES ARE LIVE!";
            } else {
                countdownEl.innerHTML = `${days} Days to Go`;
            }
        }

        // --- 3. ROTATION LOGIC & BACKGROUND SWAP ---

        const panels = document.querySelectorAll('.panel');
        const nextButton = document.getElementById('next-button');
        const prevButton = document.getElementById('prev-button');
        const pauseButton = document.getElementById('pause-button');
        const speedToggle = document.getElementById('speed-toggle');
        const bg1 = document.getElementById('bg-1');
        const bg2 = document.getElementById('bg-2');
        const eventSelector = document.getElementById('event-selector');

        let currentPanelIndex = 0;
        let rotationIntervalId;
        
        const SPEED_SLOW = 15000;
        const SPEED_FAST = 5000;
        let currentRotationSpeed = SPEED_SLOW;
        let isPaused = false;
        let activeBackground = 1;
        
        const toggleButtons = document.querySelectorAll('.view-toggle-button');


        function startRotation() {
            if (rotationIntervalId) {
                clearInterval(rotationIntervalId);
            }
            if (!isPaused) {
                rotationIntervalId = setInterval(rotatePanel, currentRotationSpeed);
            }
        }
        
        function changeBackgroundOnPanelCycle() {
            if (activeBackground === 1) {
                bg1.style.opacity = 0;
                bg2.style.opacity = 1;
                activeBackground = 2;
            } else {
                bg1.style.opacity = 1;
                bg2.style.opacity = 0;
                activeBackground = 1;
            }
        }

        function rotatePanel(direction = 1) {
            panels[currentPanelIndex].classList.remove('active');
            
            currentPanelIndex = (currentPanelIndex + direction + panels.length) % panels.length;
            
            panels[currentPanelIndex].classList.add('active');

            // Hide/Show dropdown and controls based on panel
            if (panels[currentPanelIndex].id === 'medal-tally') {
                eventSelector.style.display = 'block';
                document.getElementById('view-toggles').style.display = 'block';
                document.getElementById('refresh-data').style.display = 'inline-block';
                updateDataSourceIndicator('success');
            } else {
                eventSelector.style.display = 'none';
                document.getElementById('view-toggles').style.display = 'none';
                document.getElementById('refresh-data').style.display = 'none';
                document.getElementById('chartjs-tooltip').style.opacity = 0; // Hide tooltip on panel switch
            }

            changeBackgroundOnPanelCycle();

            if (!isPaused) {
                startRotation(); 
            }
        }

        nextButton.addEventListener('click', () => rotatePanel(1));
        prevButton.addEventListener('click', () => rotatePanel(-1));
        
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? '‚ñ∂Ô∏è PLAY' : '‚è∏Ô∏è PAUSE';
            pauseButton.style.backgroundColor = isPaused ? '#00A86B' : 'var(--color-accent)';

            if (isPaused) {
                clearInterval(rotationIntervalId);
            } else {
                startRotation();
            }
        });

        speedToggle.addEventListener('click', () => {
            if (currentRotationSpeed === SPEED_SLOW) {
                currentRotationSpeed = SPEED_FAST;
                speedToggle.textContent = 'üöÄ FAST SWAP (5s)';
                speedToggle.style.backgroundColor = '#0070c0';
            } else {
                currentRotationSpeed = SPEED_SLOW;
                speedToggle.textContent = 'üê¢ SLOW SWAP (15s)';
                speedToggle.style.backgroundColor = '#555';
            }
            if (!isPaused) {
                startRotation(); 
            }
        });
        
        eventSelector.addEventListener('change', (e) => {
            loadHistoricalData(e.target.value, currentChartType);
        });

        // Refresh button handler
        const refreshButton = document.getElementById('refresh-data');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                console.log('Manual refresh triggered');
                loadHistoricalData(currentChartDataKey, currentChartType, true);
            });
        }

        // View Toggle Logic
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const newType = this.getAttribute('data-type');
                if (newType !== currentChartType) {
                    // Update button classes
                    toggleButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // Re-render chart with new view type
                    loadHistoricalData(currentChartDataKey, newType);
                }
            });
        });


        // --- 4. INITIALIZATION ---

        function initDashboard() {
            renderSchedule();
            loadHistoricalData('2026-current', currentChartType);
            updateCountdown();
            startRotation();

            eventSelector.style.display = 'none';
            document.getElementById('view-toggles').style.display = 'none';
            document.getElementById('refresh-data').style.display = 'none';

            setInterval(updateCountdown, 1000);

            // Auto-refresh data every 5 minutes
            setInterval(() => {
                if (panels[currentPanelIndex].id === 'medal-tally') {
                    console.log('Auto-refreshing medal data...');
                    loadHistoricalData(currentChartDataKey, currentChartType, true);
                }
            }, CACHE_DURATION);

            // Update data source indicator every minute
            setInterval(() => {
                if (panels[currentPanelIndex].id === 'medal-tally') {
                    updateDataSourceIndicator('success');
                }
            }, 60000);

            // Re-render chart on resize to maintain responsiveness and reset fonts
            window.addEventListener('resize', () => loadHistoricalData(currentChartDataKey, currentChartType));
        }

        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>
</html>
